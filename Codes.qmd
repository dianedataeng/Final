---
title: "Source Code"
---

# Research Question 1: **What predictors can help determine whether an ER visit results in inpatient admission?**

Library Download

```{r}
library(tidymodels)
library(glmnet)
library(xgboost)
library(vip)
library(haven)
library(ranger)
library(randomForest)
library(tree)
library(ISLR)
library(dplyr)
library (plotly)
library (car)
```

Research Questions: 2. Which type of ER visits are the costliest for total ER expenditures? Types of tests / diagnostics? \*note: Total ER expenditure is different than out of pocket

```{r}
OGData= read.csv("C:/Users/diane/downloads/h248e.csv")
```

Looking for Missing Values -1,-7,-8 shows missing / dont know vairbales completely remove varibles with these negative values - this dropped 317 observations

```{r include=FALSE}
table(is.na(OGData)) #no missing data
str (OGData) #shows variables are all integers and numeric

OGData_clean <- OGData %>% #only took variables greater than 0
  filter(
    # ── RQ1 & RQ2: Tests, diagnostics, and services received ──
    MRI_M18     >= 0,    # MRI/CT scan
    SURGPROC    >= 0,    # Surgery performed
    XRAYS_M18   >= 0,    # X-rays
    LABTEST_M18 >= 0,    # Lab tests
    EKG_M18     >= 0,    # EKG/ECG
    SONOGRAM_M18 >= 0,   # Ultrasound
    MAMMOG_M18  >= 0,    # Mammogram
    RCVVAC_M18  >= 0,    # Vaccination
    MEDPRESC    >= 0,    # Medicine prescribed
    VSTRELCN    >= 0,    # Related to specific condition?
    
    # ── RQ2: Total expenditure and weight ──
    ERXP23X     >= 0,    # Total ER expenditure (main outcome)
    PERWT23F    >  0,    # Survey weight (always positive)
    
    # ── RQ1: Admission flag ──
    ERHEVIDX    >= -1,   # -1 = treat-and-release, >0 = admitted (allow -1!)
    
    # ── RQ3: Out-of-pocket and payment sources (facility + doctor) ──
    ERFSF23X    >= 0,    # OOP facility - this is Out of pocket costs to the facility / ER visit room
    ERDSF23X    >= 0,    # OOP doctor - out of pocket costs to the doctors
    ERFPV23X    >= 0,    # Private insurance payment (facility)
    ERDPV23X    >= 0,    # Private insurance payment (doctor)
    ERFMD23X    >= 0,    # Medicaid payment (facility)
    ERDMD23X    >= 0,    # Medicaid payment (doctor)
    ERFMR23X    >= 0,    # Medicare payment (facility)
    ERDMR23X    >= 0     # Medicare payment (doctor)
  )

dim(OGData) #4241
dim(OGData_clean) #3924
bad_rows <- OGData %>% anti_join(OGData_clean)
dim(bad_rows)
```

Renaming Variables

```{r}
OGData_clean <- OGData %>%
  # ── Keep only the variables we actually use across all 3 RQs ──
dplyr:: select(
    # Person-level ID and survey weight
    person_id   = DUPERSID,
    weight      = PERWT23F,
    
    # ── RQ1: Predict hospital admission ──
    admitted    = ERHEVIDX,        # will recode below
    
    # Tests & diagnostics performed in ER (all yes/no → 0/1)
    mri_ct      = MRI_M18,
    surgery     = SURGPROC,
    xray        = XRAYS_M18,
    lab_tests   = LABTEST_M18,
    ekg         = EKG_M18,
    ultrasound  = SONOGRAM_M18,
    mammogram   = MAMMOG_M18,
    vaccination = RCVVAC_M18,
    rx_given    = MEDPRESC,
    related_condition = VSTRELCN,
    
    # ── RQ2: Total ER cost drivers ──
    total_cost  = ERXP23X,         # total expenditure (facility + doctor)
    
    # ── RQ3: Out-of-pocket by insurance ──
    oop_facility = ERFSF23X,       # self/family OOP facility
    oop_doctor   = ERDSF23X,       # self/family OOP doctor
    
    private_fac  = ERFPV23X,
    private_doc  = ERDPV23X,
    medicaid_fac = ERFMD23X,
    medicaid_doc = ERDMD23X,
    medicare_fac = ERFMR23X,
    medicare_doc = ERDMR23X
  )
```

Adding in Insurance Information

```{r}
#Cleaning Data to find Insurance v No Insurance
OGData_clean <- OGData_clean %>%
  mutate(Insurance = case_when(
    (private_fac > 0  |  private_doc > 0 | medicaid_fac > 0 | medicaid_doc > 0 | medicare_fac > 0 | medicare_doc > 0) ~ "1",
    TRUE ~ "0"
  ))

OGData_clean$Insurance <- as.numeric(OGData_clean$Insurance)

```

Cleaning up binary data Clean More Data - Deal with 95 & 1&2 to 0,1 remove -8 dont know variables 1 is yes 2 is no - changing to 0,1 - no - 0 yes 1

```{r}

yesno_vars <- c(
  "mri_ct", "surgery", "xray", "lab_tests", "ekg",
  "ultrasound", "mammogram", "vaccination", "rx_given",
  "related_condition")

OGData_clean <- OGData_clean %>%
  mutate(across(all_of(yesno_vars), ~ ifelse(. == 1, 1, 0))) #keeps all the 1's and replaces the rest with 0

#cleaning admitted inpatient for RQ1
OGData_clean$admitted <- ifelse(OGData_clean$admitted == "-1", 0, 1) #-1 not admitted - changing to 0;; recoding 1 to be admitted
table(OGData_clean$admitted) #not admitted 3345; admitted:896

```

Data Visualization for RQ1 - Skewed Data

```{r}

#creating new dataset to recode Admitted ad MRI CT to Yes / no
RQ1Viz <- OGData_clean %>%
mutate(admitted = factor(admitted, levels = c(0,1), labels = c("No","Yes")),
        mri_ct = factor(mri_ct, levels = c(0,1), labels = c("No","Yes")))


ggplotly (ggplot(RQ1Viz, aes(x = factor(admitted), fill = factor(admitted))) +
  geom_bar(position = "dodge") +
  labs(
    title = "Count of ER Visits by In Patient Admission Status",
    x = "In Patient Admitted",
    y = "Count",
    fill = "Admitted"
  ) +
  theme_minimal())


ggplotly(ggplot(RQ1Viz, aes(x = factor(admitted), fill = factor(mri_ct))) +
  geom_bar(position = "dodge") +
  labs(
    title = "Hospital Admission by Whether MRI CT Was Performed",
    x = "In Patient Admitted",
    y = "Count",
    fill = "MRI CT"
  ) +
  geom_bar(position = "stack")+
  theme_minimal())



ggplotly (ggplot(OGData_clean, aes(x = factor(admitted), fill = factor(surgery))) +
  geom_bar(position = "dodge") +
  labs(
    title = "Hospital Admission by Whether Surgery Was Performed",
    x = "Admitted (0 = No, 1 = Yes)",
    y = "Count",
    fill = "Surgery (0 = No, 1 = Yes)"
  ) +
  geom_bar(position = "stack")+
  theme_minimal())



```

RQ 1 1. What predictors can help determine whether an ER visit results in an inpatient admission? Explore a number of predictors such as type of tests, diagnostics, and reason for visit

he confusion matrix, and sensitivity/recall for the “admitted” class (how many admitted patients your model correctly identifies).

ADD VARIABLE SELECTION METHOD BEFORE THIS\*\*\*\*

```{r}
RQ1Data <- OGData_clean %>%
  dplyr:: select(admitted,        
    mri_ct      ,
    surgery,
    xray ,
    lab_tests ,
    ekg    ,
    ultrasound ,
    mammogram ,
    vaccination ,
    rx_given ,
    related_condition,
    Insurance)


```

Train & Test

```{r}
library(caret)
library(car)


set.seed(1)
train_index = createDataPartition(RQ1Data$admitted, p = 0.8, list = FALSE) #createdatapartition ensures that admitted / not admitted are acurately represented in both train and test set*
train_data = RQ1Data[train_index, ]
test_data = RQ1Data[-train_index, ]
```

Logistic Regression

```{r}
glm_model <- glm(admitted ~ ., data = RQ1Data, family = "binomial")
vif(glm_model) #no multicolinerarity

#Train Data to predict admitted with Logistic Regression
glm.admitted=glm(admitted~.,data=train_data,family="binomial") #the . after ~ shows all variables
summary (glm.admitted)


# Make predictions on the test set
predictionsLR = predict(glm.admitted, newdata = test_data, type = "response")

# Convert to class labels
LR_pred <- factor(ifelse(predictionsLR > 0.5, 1, 0), levels = c(0, 1))
LR_truth <- factor(test_data$admitted, levels = c(0, 1))

# Confusion matrix
LR_cm <- confusionMatrix(LR_pred, LR_truth) #81.9% accuracy
LR_cm

#MSE
mean((predictionsLR - test_data$admitted)^2) # 0.129

```

Random Forest RQ1 - Classification Handles skewed data better

```{r}
library(randomForest)
library(caret)

# Train a Random Forest model to predict admitted
rf_model = randomForest(as.factor(admitted) ~ ., data = train_data, ntree = 500)
varImpPlot(rf_model)
rf_model
(plot(rf_model))
summary (rf_model)

# Make predictions on the test set
predictions = predict(rf_model, newdata = test_data)

#model performance
#rf_model$mse
#which.min(mse) #362 trees used 

mean(predictions == test_data$admitted) #81.7
confusionMatrix(predictions, as.factor(test_data$admitted)) #confusion matrix

```

# Research Question 2: Which characteristics of an ER visit are most strongly associated with the highest total ER expenditure?

---
title: "RQ2"
author: "Diane"
date: "2025-12-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Library Download

```{r}
library(tidymodels)
library(glmnet)
library(xgboost)
library(vip)
library(haven)
library(ranger)
library(randomForest)
library(tree)
library(ISLR)
library(dplyr)
library (plotly)
library(ggplot2)
library(dplyr)
library(caret)

```

Adding in Insurance Information

```{r}
#Cleaning Data to find Insurance v No Insurance
OGData_clean <- OGData_clean %>%
  mutate(Insurance = case_when(
    (private_fac > 0  |  private_doc > 0 | medicaid_fac > 0 | medicaid_doc > 0 | medicare_fac > 0 | medicare_doc > 0) ~ "1",
    TRUE ~ "0"
  ))

OGData_clean$Insurance <- as.numeric(OGData_clean$Insurance)

```

Cleaning up binary data Clean More Data - Deal with 95 & 1&2 to 0,1 remove -8 dont know variables 1 is yes 2 is no - changing to 0,1 - no - 0 yes 1

```{r}

yesno_vars <- c(
  "mri_ct", "surgery", "xray", "lab_tests", "ekg",
  "ultrasound", "mammogram", "vaccination", "rx_given",
  "related_condition")

OGData_clean <- OGData_clean %>%
  mutate(across(all_of(yesno_vars), ~ ifelse(. == 1, 1, 0))) #keeps all the 1's and replaces the rest with 0

#cleaning admitted inpatient for RQ1
OGData_clean$admitted <- ifelse(OGData_clean$admitted == "-1", 0, 1) #-1 not admitted - changing to 0;; recoding 1 to be admitted
table(OGData_clean$admitted) #not admitted 3345; admitted:896

```

RQ2 Question 2. Which characteristics of an ER visit (specific tests, procedures, or diagnoses) are most strongly associated with the highest total ER expenditures? A lot of outliers

Making Dataset for RQ2

```{r}
RQ2Data <- OGData_clean %>%
  dplyr:: select( admitted,       
    mri_ct      ,
    surgery,
    xray ,
    lab_tests ,
    ekg    ,
    ultrasound ,
    mammogram ,
    vaccination ,
    rx_given ,
    related_condition,
    total_cost)
  
```

Exploring Dataset / Characteristics

```{r}
summary (RQ2Data$total_cost) #Median - 578, Mean 1227.9 Max: 195314.5

sum(RQ2Data$total_cost == 0, na.rm = TRUE) #367 cases with 0 out of pocket cost
sum(RQ2Data$total_cost != 0, na.rm = TRUE) #3874 cases with more than 0 out of pocket

RQ2DataViz <- RQ2Data %>%
mutate(cost_group = ifelse(total_cost == 0, "0", ">0"))

#Bar Chart showing majority has more than $0 Costs
ggplotly (ggplot(RQ2DataViz, aes(x = cost_group, fill = cost_group)) +
geom_bar() +
xlab("Total Cost") +
ylab("Count") +
ggtitle("Count of 0 vs >0 Total Cost") +
theme_minimal())

#Boxplot of Total Cost
ggplotly(ggplot(RQ2Data, aes(x = "", y = total_cost)) +
geom_boxplot(fill = "steelblue")
  + # focus on main range
  ggtitle("Total Cost Distribution of ER Visits") +
  xlab("Total Cost ($)") +
  ylab("Count")+
coord_cartesian(ylim = c(0, 5000))) #this was able to show the box because of so many outliers / noise

#showing the distribution of total cost
ggplot(RQ2Data, aes(x = total_cost)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7) +
  scale_x_continuous(limits = c(0, 5000)) + # focus on main range
  ggtitle("Total Cost Distribution of ER Visits") +
  xlab("Total Cost ($)") +
  ylab("Count") +
  theme_minimal() 



```

Random Forest Model because a lot of outliers

```{r}
library(randomForest)
library(caret)

set.seed(1)
train_index1 = createDataPartition(RQ2Data$total_cost, p = 0.7, list = FALSE) 
train_data1 = RQ2Data[train_index1, ]
test_data1 = RQ2Data[-train_index1, ]


rf.RQ2=randomForest(total_cost~.,data=train_data1, ntree = 500, importance = TRUE)
varImpPlot(rf.RQ2)
rf.RQ2
plot(rf.RQ2)
importance(rf.RQ2)
summary (rf.RQ2)

#REGRESSION ANALYSIS FOR CONTINUOUS VARIABLE
# Make predictions on the test set
predictionsRQ2 = predict(rf.RQ2, newdata = test_data1)

# Evaluate the model performance
# Regression metrics
rmse <- sqrt(mean((test_data1$total_cost - predictionsRQ2)^2)) #RMSE 997.89
mae  <- mean(abs(test_data1$total_cost - predictionsRQ2)) #MAE: 243.08
rsq  <- cor(test_data1$total_cost, predictionsRQ2)^2 #RSQLM: 0.97

```

Multiple Linear Regression Model

```{r}

fit = lm(total_cost ~ ., data = train_data1)
pred_lm = predict(fit, newdata = test_data1)

summary(fit)

sqrt(mean((test_data1$total_cost - pred_lm)^2)) #RMSE 3689.77
mean(abs(test_data1$total_cost - pred_lm)) #MAE: 1147.58
cor(test_data1$total_cost, pred_lm)^2 #RSQLM:0.1324599

```

# Research Question 3: What impacts the number of tests and procedures a patient gets done in the ER?

Cleaning up binary data Clean More Data - Deal with 95 & 1&2 to 0,1 remove -8 dont know variables 1 is yes 2 is no - changing to 0,1 - no - 0 yes 1

```{r}

yesno_vars <- c(
  "mri_ct", "surgery", "xray", "lab_tests", "ekg",
  "ultrasound", "mammogram", "vaccination", "rx_given",
  "related_condition")

OGData_clean <- OGData_clean %>%
  mutate(across(all_of(yesno_vars), ~ ifelse(. == 1, 1, 0))) #keeps all the 1's and replaces the rest with 0

#cleaning admitted inpatient for RQ1
OGData_clean$admitted <- ifelse(OGData_clean$admitted == "-1", 0, 1) #-1 not admitted - changing to 0;; recoding 1 to be admitted
```

Adding in Insurance Information

```{r}
#Cleaning Data to find Insurance v No Insurance
RQ3Data <- OGData_clean %>%
  mutate(Insurance = case_when(
    (private_fac > 0  |  private_doc > 0 | medicaid_fac > 0 | medicaid_doc > 0 | medicare_fac > 0 | medicare_doc > 0) ~ "1",
    TRUE ~ "0"
  ))

RQ3Data$Insurance <- as.numeric(RQ3Data$Insurance)

#Count the total number of tests / procedures done for pt
test_vars <- c("mri_ct", "surgery", "xray", "lab_tests", 
               "ekg", "ultrasound", "mammogram", 
               "vaccination", "rx_given", "related_condition")

# Create new variable
RQ3Data <- RQ3Data %>%
  rowwise() %>%
  mutate(total_tests = sum(c_across(all_of(test_vars)), na.rm = TRUE)) %>%
  ungroup()

RQ3Data<- RQ3Data %>%
  dplyr:: select(Insurance, total_tests,person_id) #added ID or dupersid to merge later


```

Merging New Dataset

```{r}
library(haven)
library(dplyr)

#dowloaded the SAS File & filtering only the variables needed
MergeDataDemo <- read_sas("C:/Users/diane/Downloads/h251.sas7bdat") %>%
  dplyr::select(DUPERSID, SEX,#1 male, 2 female
                POVCAT23) #1 is low income to 5 high

RQ3Data <- RQ3Data %>%
  mutate(person_id = as.numeric(person_id))

MergeDataDemo <- MergeDataDemo %>%
  mutate(DUPERSID = as.numeric(DUPERSID))

MergedDataRQ3 <- RQ3Data %>%
  left_join(MergeDataDemo, by = c("person_id" = "DUPERSID"))

MergedDataRQ3 <- MergedDataRQ3 %>%
   dplyr::select(-person_id)#no need after merge

#changing sex to 0,1 (male 0 female 1)
MergedDataRQ3 <- MergedDataRQ3 %>%
  mutate(SEX = ifelse(SEX == 1, 0,
                      ifelse(SEX == 2, 1, NA)))

#Missing Data
sum(is.na(MergedDataRQ3)) #no missing
```

Data Visualization

```{r}
library (ggplot2)
library (plotly)
#making the visualization show yes / no
RQ3Viz <- MergedDataRQ3 %>%
  mutate(Insurance = factor(Insurance,
                            levels = c(0, 1),
                            labels = c("No", "Yes")))


ggplotly(ggplot(RQ3Viz, aes(x = factor(POVCAT23), fill = Insurance)) +
  geom_bar(position = "dodge") +
  labs(x = "Poverty Category", y = "Count",
       title = "Poverty Category by Insurance Status"))
#high income has a higher no insurance rate than the very low

#table of insurance & poverty category
table(RQ3Viz$Insurance, RQ3Viz$POVCAT23)
prop.table(table(RQ3Viz$Insurance, RQ3Viz$POVCAT23), margin = 1) * 100 #proporations



table (RQ3Viz$Insurance)# Imbalanced data 644 No insurance 3597 Insurance
table (RQ3Viz$total_tests)
str (RQ3Viz) #all numerical

prop.table(table(RQ3Viz$Insurance, RQ3Viz$total_tests), margin = 1) * 100


#left skewed normal distribution - try to add a line showing the distribution - create different one then overlap?
ggplotly(ggplot(RQ3Viz, aes(x = factor(total_tests), fill = factor(Insurance))) +
  geom_bar(position = "dodge") +
  labs(
    title = "Number of ER Tests by Insurance Status",
    x = "Total Tests/Procedures",
    y = "Number of Patients",
    fill = "Insurance"
  ) +
  theme_minimal())
  


```

Multiple Linear Regression

```{r}
library (caret)

set.seed(1)
train_index3 <- createDataPartition(MergedDataRQ3$total_tests, 
                                    p = 0.7, 
                                    list = FALSE)

# Training and testing datasets
train_data3 <- MergedDataRQ3[train_index3, ]
test_data3 <- MergedDataRQ3[-train_index3, ]

#traing on train data
fit3 <- lm(total_tests ~ factor(Insurance) + factor(SEX) + factor(POVCAT23),
           data = train_data3)
#Test on test
pred_lm3 = predict(fit3, newdata = test_data3)

summary(fit3)

#Performance on Test Data
RMSE(pred_lm3, test_data3$total_tests) #1.37 RMSE
mean(abs(test_data3$total_tests - pred_lm3)) #1.115986 MAE
cor(test_data3$total_tests, pred_lm3)^2 #0.007887108 RSQLM

var(test_data3$total_tests) #1.9 most people in the data has 1.9 tests done - mean with fewer high/lower; low variance

#hm = lm(Insurance ~ SEX, data = MergedDataRQ3)
#summary (hm) #Being female (SEX = 1) increases probability of being insured by ~6.6%, holding everything else constant.

```

Poisson regression

```{r}

set.seed(1)

#Poisson Model on Train Data
model_pois <- glm(total_tests ~ factor(Insurance) + factor(SEX) + factor(POVCAT23),
                  family = poisson(link = "log"), data = train_data3)
#making prediction on test data
Poss_pred_lm3 = predict(model_pois, newdata = test_data3,type = "response")

summary(model_pois)

RMSE(test_data3$total_tests, Poss_pred_lm3) #1.373308 RMSE
mean(abs(test_data3$total_tests - Poss_pred_lm3)) #1.116015 MAE
cor(test_data3$total_tests, Poss_pred_lm3)^2 #0.007838005 RSQLM


```

Random Forest Regression

```{r}
library(randomForest)

train_data3 <- MergedDataRQ3[train_index3, ]
test_data3 <- MergedDataRQ3[-train_index3, ]

rf.RQ3=randomForest(total_tests~.,data=train_data3, ntree = 500, importance = TRUE)

#REGRESSION ANALYSIS FOR CONTINUOUS VARIABLE
# Make predictions on the test set
predictionsRQ3 = predict(rf.RQ3, newdata = test_data3)

varImpPlot(rf.RQ3)
rf.RQ3
plot(rf.RQ3)
importance(rf.RQ3)
summary (rf.RQ3)

# Evaluate the model performance on test
# Regression metrics
sqrt(mean((test_data3$total_tests - predictionsRQ3)^2)) #RMSE 1.371164
mean(abs(test_data3$total_tests - predictionsRQ3)) #MAE: 1.116
cor(test_data3$total_tests , predictionsRQ3)^2 #RSQLM: 0.01054665

```
