---
title: "RQ2"
author: "Diane"
date: "2025-12-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Library Download

```{r}
library(tidymodels)
library(glmnet)
library(xgboost)
library(vip)
library(haven)
library(ranger)
library(randomForest)
library(tree)
library(ISLR)
library(dplyr)
library (plotly)
library(ggplot2)
library(dplyr)
library(caret)

```

Research Questions: 2. Which type of ER visits are the costliest for total ER expenditures? Types of tests / diagnostics? \*note: Total ER expenditure is different than out of pocket

```{r}
OGData= read.csv("C:/Users/diane/downloads/h248e.csv")
```

Looking for Missing Values -1,-7,-8 shows missing / dont know vairbales completely remove varibles with these negative values - this dropped 317 observations

```{r}
table(is.na(OGData)) #no missing data
str (OGData) #shows variables are all integers and numeric

OGData_clean <- OGData %>% #only took variables greater than 0
  filter(
    # ── RQ1 & RQ2: Tests, diagnostics, and services received ──
    MRI_M18     >= 0,    # MRI/CT scan
    SURGPROC    >= 0,    # Surgery performed
    XRAYS_M18   >= 0,    # X-rays
    LABTEST_M18 >= 0,    # Lab tests
    EKG_M18     >= 0,    # EKG/ECG
    SONOGRAM_M18 >= 0,   # Ultrasound
    MAMMOG_M18  >= 0,    # Mammogram
    RCVVAC_M18  >= 0,    # Vaccination
    MEDPRESC    >= 0,    # Medicine prescribed
    VSTRELCN    >= 0,    # Related to specific condition?
    
    # ── RQ2: Total expenditure and weight ──
    ERXP23X     >= 0,    # Total ER expenditure (main outcome)
    PERWT23F    >  0,    # Survey weight (always positive)
    
    # ── RQ1: Admission flag ──
    ERHEVIDX    >= -1,   # -1 = treat-and-release, >0 = admitted (allow -1!)
    
    # ── RQ3: Out-of-pocket and payment sources (facility + doctor) ──
    ERFSF23X    >= 0,    # OOP facility - this is Out of pocket costs to the facility / ER visit room
    ERDSF23X    >= 0,    # OOP doctor - out of pocket costs to the doctors
    ERFPV23X    >= 0,    # Private insurance payment (facility)
    ERDPV23X    >= 0,    # Private insurance payment (doctor)
    ERFMD23X    >= 0,    # Medicaid payment (facility)
    ERDMD23X    >= 0,    # Medicaid payment (doctor)
    ERFMR23X    >= 0,    # Medicare payment (facility)
    ERDMR23X    >= 0     # Medicare payment (doctor)
  )

dim(OGData) #4241
dim(OGData_clean) #3924

```

Renaming Variables

```{r}
OGData_clean <- OGData %>%
  # ── Keep only the variables we actually use across all 3 RQs ──
dplyr:: select(
    # Person-level ID and survey weight
    person_id   = DUPERSID,
    weight      = PERWT23F,
    
    # ── RQ1: Predict hospital admission ──
    admitted    = ERHEVIDX,        # will recode below
    
    # Tests & diagnostics performed in ER (all yes/no → 0/1)
    mri_ct      = MRI_M18,
    surgery     = SURGPROC,
    xray        = XRAYS_M18,
    lab_tests   = LABTEST_M18,
    ekg         = EKG_M18,
    ultrasound  = SONOGRAM_M18,
    mammogram   = MAMMOG_M18,
    vaccination = RCVVAC_M18,
    rx_given    = MEDPRESC,
    related_condition = VSTRELCN,
    
    # ── RQ2: Total ER cost drivers ──
    total_cost  = ERXP23X,         # total expenditure (facility + doctor)
    
    # ── RQ3: Out-of-pocket by insurance ──
    oop_facility = ERFSF23X,       # self/family OOP facility
    oop_doctor   = ERDSF23X,       # self/family OOP doctor
    
    private_fac  = ERFPV23X,
    private_doc  = ERDPV23X,
    medicaid_fac = ERFMD23X,
    medicaid_doc = ERDMD23X,
    medicare_fac = ERFMR23X,
    medicare_doc = ERDMR23X
  )
```

Adding in Insurance Information

```{r}
#Cleaning Data to find Insurance v No Insurance
OGData_clean <- OGData_clean %>%
  mutate(Insurance = case_when(
    (private_fac > 0  |  private_doc > 0 | medicaid_fac > 0 | medicaid_doc > 0 | medicare_fac > 0 | medicare_doc > 0) ~ "1",
    TRUE ~ "0"
  ))

OGData_clean$Insurance <- as.numeric(OGData_clean$Insurance)

```

Cleaning up binary data Clean More Data - Deal with 95 & 1&2 to 0,1 remove -8 dont know variables 1 is yes 2 is no - changing to 0,1 - no - 0 yes 1

```{r}

yesno_vars <- c(
  "mri_ct", "surgery", "xray", "lab_tests", "ekg",
  "ultrasound", "mammogram", "vaccination", "rx_given",
  "related_condition")

OGData_clean <- OGData_clean %>%
  mutate(across(all_of(yesno_vars), ~ ifelse(. == 1, 1, 0))) #keeps all the 1's and replaces the rest with 0

#cleaning admitted inpatient for RQ1
OGData_clean$admitted <- ifelse(OGData_clean$admitted == "-1", 0, 1) #-1 not admitted - changing to 0;; recoding 1 to be admitted
table(OGData_clean$admitted) #not admitted 3345; admitted:896

```

RQ2 Question 2. Which characteristics of an ER visit (specific tests, procedures, or diagnoses) are most strongly associated with the highest total ER expenditures? A lot of outliers

Making Dataset for RQ2

```{r}
RQ2Data <- OGData_clean %>%
  dplyr:: select( admitted,       
    mri_ct      ,
    surgery,
    xray ,
    lab_tests ,
    ekg    ,
    ultrasound ,
    mammogram ,
    vaccination ,
    rx_given ,
    related_condition,
    total_cost)
  
```

Exploring Dataset / Characteristics

```{r}
summary (RQ2Data$total_cost) #Median - 578, Mean 1227.9 Max: 195314.5

sum(RQ2Data$total_cost == 0, na.rm = TRUE) #367 cases with 0 out of pocket cost
sum(RQ2Data$total_cost != 0, na.rm = TRUE) #3874 cases with more than 0 out of pocket

RQ2DataViz <- RQ2Data %>%
mutate(cost_group = ifelse(total_cost == 0, "0", ">0"))

#Bar Chart showing majority has more than $0 Costs
ggplotly (ggplot(RQ2DataViz, aes(x = cost_group, fill = cost_group)) +
geom_bar() +
xlab("Total Cost") +
ylab("Count") +
ggtitle("Count of 0 vs >0 Total Cost") +
theme_minimal())

#Boxplot of Total Cost
ggplotly(ggplot(RQ2Data, aes(x = "", y = total_cost)) +
geom_boxplot(fill = "steelblue")
  + # focus on main range
  ggtitle("Total Cost Distribution of ER Visits") +
  xlab("Total Cost ($)") +
  ylab("Count")+
coord_cartesian(ylim = c(0, 5000))) #this was able to show the box because of so many outliers / noise

#showing the distribution of total cost
ggplot(RQ2Data, aes(x = total_cost)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7) +
  scale_x_continuous(limits = c(0, 5000)) + # focus on main range
  ggtitle("Total Cost Distribution of ER Visits") +
  xlab("Total Cost ($)") +
  ylab("Count") +
  theme_minimal() 



```

Random Forest Model because a lot of outliers

```{r}
library(randomForest)
library(caret)

set.seed(1)
train_index1 = createDataPartition(RQ2Data$total_cost, p = 0.7, list = FALSE) 
train_data1 = RQ2Data[train_index1, ]
test_data1 = RQ2Data[-train_index1, ]


rf.RQ2=randomForest(total_cost~.,data=train_data1, ntree = 500, importance = TRUE)
varImpPlot(rf.RQ2)
rf.RQ2
plot(rf.RQ2)
importance(rf.RQ2)
summary (rf.RQ2)

#REGRESSION ANALYSIS FOR CONTINUOUS VARIABLE
# Make predictions on the test set
predictionsRQ2 = predict(rf.RQ2, newdata = test_data1)

# Evaluate the model performance
# Regression metrics
rmse <- sqrt(mean((test_data1$total_cost - predictionsRQ2)^2)) #RMSE 997.89
mae  <- mean(abs(test_data1$total_cost - predictionsRQ2)) #MAE: 243.08
rsq  <- cor(test_data1$total_cost, predictionsRQ2)^2 #RSQLM: 0.97

```

Multiple Linear Regression Model

```{r}

fit = lm(total_cost ~ ., data = train_data1)
pred_lm = predict(fit, newdata = test_data1)

summary(fit)

sqrt(mean((test_data1$total_cost - pred_lm)^2)) #RMSE 3689.77
mean(abs(test_data1$total_cost - pred_lm)) #MAE: 1147.58
cor(test_data1$total_cost, pred_lm)^2 #RSQLM:0.1324599

```
